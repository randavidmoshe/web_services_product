# fluent-bit-docker.conf
# Fluent Bit configuration that reads from Docker socket
# This allows BOTH docker-compose logs AND CloudWatch to work
# Location: web_services_product/fluent-bit-docker.conf
#
# USE THIS CONFIGURATION if you want Option C (both local logs and CloudWatch)

[SERVICE]
    Flush         5
    Daemon        Off
    Log_Level     info
    Parsers_File  parsers.conf

# Collect logs from Docker containers via socket
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Docker_Mode       On
    Docker_Mode_Flush 5
    Refresh_Interval  10
    Mem_Buf_Limit     5MB

# Parse JSON logs from containers
[FILTER]
    Name          parser
    Match         docker.*
    Key_Name      log
    Parser        json
    Reserve_Data  On

# Add environment tag
#[FILTER]
#    Name          record_modifier
#    Match         *
#    Record        environment ${ENVIRONMENT}

# Filter only api-server and celery-worker containers
#[FILTER]
#    Name          grep
#    Match         docker.*
#    Regex         container_name (api-server|celery-worker)

# Send to CloudWatch Logs
[OUTPUT]
    Name                cloudwatch_logs
    Match               *
    region              ${AWS_REGION}
    log_group_name      /quattera/${ENVIRONMENT}
    log_stream_prefix   ${HOSTNAME}-
    auto_create_group   true
    log_retention_days  30

# Also keep logs locally (stdout) for debugging Fluent Bit itself
[OUTPUT]
    Name   stdout
    Match  fluent-bit.*
    Format json
