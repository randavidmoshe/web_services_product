services:
  # ==========================================================================
  # Nginx Reverse Proxy (SSL Termination)
  # ==========================================================================
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"      # HTTP (redirects to HTTPS)
      - "443:443"    # HTTPS
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
      - ./nginx/certbot:/var/www/certbot:ro  # For Let's Encrypt challenges
    depends_on:
      - web
      - api-server
      - marketing-site
    restart: unless-stopped

  # ==========================================================================
  # Web Application (Next.js) - Dashboard
  # ==========================================================================
  web:
    build: ./web-app
    # Removed external port - only accessible via Nginx
    expose:
      - "3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-password}@db:5432/formfinder
      - API_SERVER_URL=http://api-server:8000
      - NEXTAUTH_URL=${NEXTAUTH_URL:-https://localhost}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-dev-secret-change-in-production}
    depends_on:
      - db
    volumes:
      - ./web-app:/app
      - /app/node_modules
      - /app/.next
    command: npm run dev

  # ==========================================================================
  # Marketing Website (Next.js) - Public Site
  # ==========================================================================
  marketing-site:
    build: ./marketing-site
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3001
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8001}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://localhost}
    volumes:
      - ./marketing-site:/app
      - /app/node_modules
      - /app/.next
    command: npm run dev -- -p 3001

  # ==========================================================================
  # API/Processing Server (FastAPI)
  # ==========================================================================
  api-server:
    build: ./api-server
    # Removed external port - only accessible via Nginx
    # Keep 8001 for local debugging if needed (comment out in production)
    ports:
      - "8001:8000"  # TODO: Remove in production
    expose:
      - "8000"
    env_file:
      - .env
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-password}@db:5432/formfinder
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - JWT_SECRET=${JWT_SECRET:-dev-jwt-secret-change-in-production}
      - REDIS_URL=redis://redis:6379/0
      - PYTHONPATH=/app
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-eu-west-1}
      - S3_BUCKET=${S3_BUCKET:-form-discoverer-screenshots}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:3001,https://localhost}
      # SES Email Configuration
      - SES_SENDER_EMAIL=${SES_SENDER_EMAIL:-no-reply@quathera.com}
      - SES_SENDER_NAME=${SES_SENDER_NAME:-Quathera}
      - SES_SANDBOX_MODE=${SES_SANDBOX_MODE:-true}
      - SES_TEST_SENDER=${SES_TEST_SENDER:-ranlaser@gmail.com}
      - APP_URL=${APP_URL:-https://localhost}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - PYTHONUNBUFFERED=1
    depends_on:
      - db
      - redis
    volumes:
      - ./api-server:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_DB=formfinder
    ports:
      - "${DB_PORT:-5432}:5432"  # Can disable in production
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql

  # ==========================================================================
  # Redis (Message Queue)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"  # Can disable in production
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  # ==========================================================================
  # Celery Worker (Background Tasks)
  # ==========================================================================
  celery-worker:
    build: ./api-server
    command: celery -A celery_app.celery worker --loglevel=info -Q celery
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-password}@db:5432/formfinder
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379/0
      - PYTHONPATH=/app
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-eu-west-1}
      - S3_BUCKET=${S3_BUCKET:-form-discoverer-screenshots}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - PYTHONUNBUFFERED=1
    depends_on:
      - db
      - redis
    volumes:
      - ./api-server:/app
      - ./debug_screenshots:/tmp/debug_screenshots

  # ==========================================================================
  # Fluent Bit (Log shipping to CloudWatch)
  # ==========================================================================
  fluent-bit:
    image: fluent/fluent-bit:3.1.10
    container_name: quattera-fluent-bit
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./fluent-bit-docker.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - ./parsers-docker.conf:/fluent-bit/etc/parsers.conf:ro
      - fluent-bit-db:/fluent-bit/db
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-eu-west-1}
      - ENVIRONMENT=${ENVIRONMENT:-dev}
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  fluent-bit-db:
