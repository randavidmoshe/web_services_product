# Agent API Router
# Location: web_services_product/api-server/routers/agent_router.py

from fastapi import APIRouter, Depends, HTTPException, Header
from sqlalchemy.orm import Session
from typing import Optional
import asyncio
from datetime import datetime

from models.database import get_db
from models.agent_models import Agent, AgentTask
from services.agent_service import AgentService

router = APIRouter(prefix="/api/agent", tags=["agent"])


@router.post("/register")
async def register_agent(
    agent_data: dict,
    authorization: str = Header(None),
    db: Session = Depends(get_db)
):
    """
    Register a new agent or update existing agent
    Agent sends this on startup
    """
    agent_service = AgentService(db)
    
    agent = agent_service.register_agent(
        agent_id=agent_data.get('agent_id'),
        company_id=agent_data.get('company_id'),
        user_id=agent_data.get('user_id'),
        hostname=agent_data.get('hostname'),
        platform=agent_data.get('platform'),
        version=agent_data.get('version', '1.0.0')
    )
    
    return {
        "success": True,
        "agent_id": agent.agent_id,
        "message": "Agent registered successfully"
    }


@router.post("/heartbeat")
async def agent_heartbeat(
    heartbeat_data: dict,
    authorization: str = Header(None),
    db: Session = Depends(get_db)
):
    """
    Receive heartbeat from agent
    Agent sends this every 30 seconds
    """
    agent_service = AgentService(db)
    
    agent_service.update_heartbeat(
        agent_id=heartbeat_data.get('agent_id'),
        status=heartbeat_data.get('status', 'idle'),
        current_task_id=heartbeat_data.get('current_task_id')
    )
    
    return {"success": True}


@router.get("/poll-task")
async def poll_task(
    authorization: str = Header(None),
    db: Session = Depends(get_db)
):
    """
    Long polling endpoint for agents to get tasks
    Holds connection for up to 30 seconds waiting for a task
    """
    agent_service = AgentService(db)
    
    # Poll for up to 30 seconds
    max_wait = 30
    start_time = datetime.now()
    
    while (datetime.now() - start_time).seconds < max_wait:
        task = agent_service.get_pending_task()
        
        if task:
            # Mark task as assigned
            agent_service.assign_task_to_agent(task.id, "agent-placeholder")
            
            return {
                "task_id": task.task_id,
                "task_type": task.task_type,
                "parameters": task.parameters
            }
        
        # Wait a bit before checking again
        await asyncio.sleep(1)
    
    # No task found after 30 seconds
    raise HTTPException(status_code=204, detail="No tasks available")


@router.post("/task-status")
async def update_task_status(
    status_data: dict,
    authorization: str = Header(None),
    db: Session = Depends(get_db)
):
    """
    Update task status from agent
    Agent sends this when task starts, completes, or fails
    """
    agent_service = AgentService(db)
    
    agent_service.update_task_status(
        task_id=status_data.get('task_id'),
        status=status_data.get('status'),
        message=status_data.get('message'),
        result=status_data.get('result')
    )
    
    return {"success": True}


@router.get("/agents")
async def list_agents(
    company_id: Optional[int] = None,
    db: Session = Depends(get_db)
):
    """
    List all agents (for web app dashboard)
    """
    agent_service = AgentService(db)
    agents = agent_service.get_agents(company_id=company_id)
    
    return {
        "agents": [
            {
                "agent_id": agent.agent_id,
                "company_id": agent.company_id,
                "status": agent.status,
                "last_heartbeat": agent.last_heartbeat.isoformat() if agent.last_heartbeat else None,
                "platform": agent.platform,
                "hostname": agent.hostname
            }
            for agent in agents
        ]
    }


@router.post("/create-task")
async def create_task(
    task_data: dict,
    db: Session = Depends(get_db)
):
    """
    Create a new task for an agent (called by web app)
    """
    agent_service = AgentService(db)
    
    task = agent_service.create_task(
        company_id=task_data.get('company_id'),
        user_id=task_data.get('user_id'),
        task_type=task_data.get('task_type'),
        parameters=task_data.get('parameters')
    )
    
    return {
        "success": True,
        "task_id": task.task_id,
        "message": "Task created successfully"
    }


@router.get("/task-status/{task_id}")
async def get_task_status(
    task_id: str,
    db: Session = Depends(get_db)
):
    """
    Get status of a specific task (for web app)
    """
    agent_service = AgentService(db)
    task = agent_service.get_task(task_id)
    
    if not task:
        raise HTTPException(status_code=404, detail="Task not found")
    
    return {
        "task_id": task.task_id,
        "status": task.status,
        "created_at": task.created_at.isoformat() if task.created_at else None,
        "started_at": task.started_at.isoformat() if task.started_at else None,
        "completed_at": task.completed_at.isoformat() if task.completed_at else None,
        "result": task.result
    }
